<app-user-navigation-bar [position]="'static'"></app-user-navigation-bar>
<main class="px-4">
  <div class="flex items-center gap-4 mb-2">
    <p-button label="กลับ" icon="pi pi-arrow-left" (onClick)="goBack()" size="small" />
    <h1 class="text-2xl font-bold">โปรไฟล์ของฉัน</h1>
  </div>
  <div class="grid grid-cols-[25%_auto] gap-4 mt-2">
    <p-card class="overflow-hidden">
      <ng-template #header>
        <div class="flex justify-center rounded-full overflow-hidden h-1/2 w-1/2 mx-auto mt-3">
          <img
            alt="Card"
            [src]="previewImageUrl || 'http://localhost:5053' + currentUser?.profileImage"
          />
        </div>
      </ng-template>

      <div class="flex justify-center mt-2 gap-2">
        <input
          #fileInput
          type="file"
          accept="image/*"
          (change)="onImageSelected($event)"
          style="display: none"
        />
        <p-button
          icon="pi pi-upload"
          label="อัปโหลดรูปภาพ"
          variant="text"
          (onClick)="fileInput.click()"
        />
        @if (previewImageUrl) {
        <p-button
          icon="pi pi-times"
          label="ยกเลิก"
          variant="text"
          severity="secondary"
          (onClick)="resetImageSelection()"
        />
        }
      </div>
    </p-card>
    <p-card class="overflow-hidden">
      <div class="space-y-4">
        <div class="space-y-1">
          <p-floatlabel variant="on">
            <input
              pInputText
              id="username"
              name="username"
              type="text"
              fluid="true"
              [invalid]="usernameLengthError || usernameAvailable === false"
              (ngModelChange)="onUsernameChange($event)"
              [(ngModel)]="formData.username"
              [placeholder]="currentUser?.username"
            />
            <label for="username">ชื่อผู้ใช้</label>
          </p-floatlabel>
          @if (usernameLengthError) {
          <p-message severity="error" size="small" variant="simple">
            {{ usernameLengthError }}
          </p-message>
          } @if (usernameAvailable === false) {
          <p-message severity="error" size="small" variant="simple"
            >ชื่อผู้ใช้งานนี้ไม่สามารถใช้งานได้</p-message
          >
          }
        </div>
        <div class="space-y-1">
          <p-floatlabel variant="on">
            <input
              pInputText
              id="email"
              name="email"
              type="email"
              fluid="true"
              [invalid]="emailFormatError || emailAvailable === false"
              (ngModelChange)="onEmailChange($event)"
              [(ngModel)]="formData.email"
              [placeholder]="currentUser?.email"
            />
            <label for="email">อีเมล</label>
          </p-floatlabel>
          @if (emailFormatError) {
          <p-message severity="error" size="small" variant="simple">
            {{ emailFormatError }}
          </p-message>
          } @if (emailAvailable === false) {
          <p-message severity="error" size="small" variant="simple"
            >อีเมลนี้ถูกใช้งานแล้ว</p-message
          >
          }
        </div>
        <div class="space-y-1">
          <p-floatlabel variant="on">
            <input
              pInputText
              id="password"
              type="password"
              name="password"
              fluid="true"
              [(ngModel)]="formData.password"
            />
            <label for="password">รหัสผ่านใหม่</label>
          </p-floatlabel>
          @if (passwordLengthError) {
          <p-message severity="error" size="small" variant="simple">{{
            passwordLengthError
          }}</p-message>
          }
        </div>
        <div class="space-y-1">
          <p-floatlabel variant="on">
            <input
              pInputText
              id="confirm-password"
              type="password"
              name="confirmPassword"
              fluid="true"
              [(ngModel)]="formData.confirmPassword"
            />
            <label for="confirm-password">ยืนยันรหัสผ่านใหม่</label>
          </p-floatlabel>
          @if (confirmPasswordMismatchError) {
          <p-message severity="error" size="small" variant="simple">{{
            confirmPasswordMismatchError
          }}</p-message>
          }
        </div>
        <div class="flex justify-end gap-2">
          <p-button
            label="บันทึก"
            icon="pi pi-check"
            (onClick)="onSave()"
            [disabled]="!validateForm()"
          />
        </div>
      </div>
    </p-card>
  </div>
</main>
